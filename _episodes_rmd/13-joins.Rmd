---
title: Joins and data in the wild
teaching: 30
exercises: 15
questions:
- "How do I join data-sets?"
objectives:
- "To be able to join tibbles"
- "To understand the difference between the different join types"
- "To have an appreciation of some of the difficulties that can occur when using real-life data"
keypoints:
- "Use join_{left,inner,right} to join data on common values"
source: Rmd
---


```{r, include=FALSE}
source("../bin/chunk-options.R")
library(tidyverse)
knitr_fig_path("13-")
# Silently load in the data so the rest of the lesson works
gapminder <- read_csv("data/gapminder-FiveYearData.csv")
```


In this episode we will look at how to join tibbles together.  We will continue to use the gapminder data, and will look at how to join data on the medal performance of countries in the 2008 Olympics.  In doing so, we'll see some of the difficulties in working with real-world data, and will think about ways of solving them.

There are many ways of joining data in R; in common with the rest of this course we will focus on the tidyverse way, and use `dplyr` to join data.

## Loading the Olympic medal data


```{r, echo=FALSE, eval=FALSE}
# Olympic medal table - all the loading and cleaning will 
# be done outwith the lesson.  Just get participants to load 
# cleaned version.  This chunk will produce the required
# data file; it isn't run or visible in the lesson

library(rvest)
library(stringr)

medals <- read_html("https://en.wikipedia.org/wiki/2008_Summer_Olympics_medal_table") %>% 
  html_nodes(xpath='//*[@id="mw-content-text"]/div/table[2]') %>% html_table(fill=TRUE)
medals <- medals[[1]]

medals <- medals %>%
  filter(Rank != "Total (87 NOCs)") %>% 
  mutate(country=stringr::word(NOC,1, sep=fixed(intToUtf8(160)))) %>% # Delimited on &nbsp
  select(country, Gold, Silver, Bronze) %>% 
  rename(gold=Gold, silver=Silver, bronze=Bronze) 
write_csv(medals, "data/medals.csv")
```

The [medal table for the 2008 Olympic games was downloaded from Wikipedia](https://en.wikipedia.org/wiki/2008_Summer_Olympics_medal_table) and converted to a csv file.  We can load this in the same way as the gapminder data:

```{r}
medals <- read_csv("data/medals.csv")
```

We see that the column specification that `read_csv()` guessed looks reasonable; the countries are characters and columns containing the numbers of gold, silver and bronze medals have all been read as integers.

Before we join the two tables, complete the following challenges, which will generate a useful additional variable, and limit our gapminder data to the year closest to the medal data:

> ## Challenge: Generating medal totals
> 
> Use the `mutate` command to add a new column in your data-set
> called `total` that contains the total number of models awarded to 
> each country.  
>
> > ## Solution
> > 
> > ```{r}
> > medals <- medals %>% mutate(total = gold + silver + bronze)
> > ```
> > 
> {: .solution}
{: .challenge}

> ## Challenge: Filtering the gapminder data
> 
> Use `dplyr` to create a new tibble, gap2007,  that only contains data for 2007
> 
> > ## Solution
> > 
> > ```{r}
> > gap2007 <- gapminder %>% filter(year == 2007)
> > ```
> > 
> {: .solution}
{: .challenge}

## Joining data tables

Before we join the `medals` and `gap2007` data, let's consider a minimal
example of the different types of join that exist.

```{r}

library(tibble)
animallegs <- tribble(~animal, ~legs,
                      "Cat", 4,
                      "Dog", 4,
                      "Bird", 2,
                      "Fish", 0)

animalsound <- tribble(~animal, ~sound, 
                       "Cat", "miaw",
                       "Bird", "tweet",
                       "Fish", NA,
                       "Cow", "moo")

```



```{r}
# Need to think here about how we handle missings _in data_
# vs missings generated by the join
animallegs %>% inner_join(animalsound)
animallegs %>% left_join(animalsound)
animallegs %>% right_join(animalsound)
```


```{r}

medaljoin <- gapminder %>% 
  filter(year == 2007) %>% 
  inner_join(medals, by="country") # Illustrate difference between join types
```
```{r}
medaljoin %>% ggplot(aes(x=gdpPercap, y=medalTotal, colour = continent)) + 
  geom_point()
```

